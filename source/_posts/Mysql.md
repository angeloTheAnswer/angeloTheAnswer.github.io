---
title: SQL固定分组统计
top: true
cover: false
toc: true
mathjax: true
date: 2020-02-20 14:13:44
password:
summary: SQL
tags:
- SQL
categories:
- SQL
---

## 前言
*不不要在夕阳西下时幻想，要在旭日东升时努力。*

## 问题
统计每个订单各个规格的饮料销售数量以及总数.

## 表
goods表

```sh
+----+----------+-------------+------+
| id | good_sku | good_name   | size |
+----+----------+-------------+------+
|  1 | C2019001 | 可乐-0.5L   | 0.5L |
|  2 | C2019002 | 可乐-1.5L   | 1.5L |
|  3 | C2019003 | 可乐-2L     | 2L   |
+----+----------+-------------+------+
```
orders表

```sh
+----+--------------+--------+
| id | order_num    | remark |
+----+--------------+--------+
|  1 | 20190220-001 | NULL   |
|  2 | 20190220-002 | NULL   |
|  3 | 20190220-003 | NULL   |
|  4 | 20190220-004 | NULL   |
|  5 | 20190220-005 | NULL   |
+----+--------------+--------+
```

order_item表

```sh
+----+----------+----------+-------------+------+
| id | order_id | good_sku | good_name   | num  |
+----+----------+----------+-------------+------+
|  1 |        1 | C2019001 | 可乐-0.5L   |    1 |
|  2 |        1 | C2019002 | 可乐-1.5L   |    1 |
|  3 |        2 | C2019001 | 可乐-0.5L   |    2 |
|  4 |        2 | C2019002 | 可乐-1.5L   |    1 |
|  5 |        3 | C2019001 | 可乐-0.5L   |    4 |
|  6 |        3 | C2019002 | 可乐-1.5L   |    2 |
|  7 |        3 | C2019003 | 可乐-2L     |    1 |
|  8 |        4 | C2019003 | 可乐-2L     |    2 |
|  9 |        5 | C2019001 | 可乐-0.5L   |    2 |
| 10 |        5 | C2019002 | 可乐-1.5L   |    2 |
| 11 |        5 | C2019003 | 可乐-2L     |    1 |
+----+----------+----------+-------------+------+
```


## SQL

```sh
SELECT
	o.*,
	sum(
		CASE WHEN g.size = '0.5L' THEN
			i.num
		ELSE
			0
		END) AS '0.5L',
	sum(
		CASE WHEN g.size = '1.5L' THEN
			i.num
		ELSE
			0
		END) AS '1.5L',
	sum(
		CASE WHEN g.size = '2L' THEN
			i.num
		ELSE
			0
		END) AS '2L',
	sum(i.num) AS tol_num
FROM
	orders o
	LEFT JOIN order_item i ON o.id = i.order_id
	LEFT JOIN goods g ON i.good_sku = g.good_sku
GROUP BY
	o.id;
```

## SQL查询结果

```sh
+----+--------------+--------+------+------+------+---------+
| id | order_num    | remark | 0.5L | 1.5L | 2L   | tol_num |
+----+--------------+--------+------+------+------+---------+
|  1 | 20190220-001 | NULL   |    1 |    1 |    0 |       2 |
|  2 | 20190220-002 | NULL   |    2 |    1 |    0 |       3 |
|  3 | 20190220-003 | NULL   |    4 |    2 |    1 |       7 |
|  4 | 20190220-004 | NULL   |    0 |    0 |    2 |       2 |
|  5 | 20190220-005 | NULL   |    2 |    2 |    1 |       5 |
+----+--------------+--------+------+------+------+---------+
```

